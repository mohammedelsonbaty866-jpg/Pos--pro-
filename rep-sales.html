<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>مبيعات المندوب</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:Arial;
  background:#f4f6fb;
}
.header{
  background:#1f3c88;
  color:#fff;
  padding:12px;
  text-align:center;
  font-size:18px;
}
.container{
  padding:10px;
}
.card{
  background:#fff;
  border-radius:10px;
  padding:10px;
  margin-bottom:10px;
}
input,select,button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:15px;
}
button{
  background:#1f3c88;
  color:#fff;
  border:none;
}
button.small{
  width:48%;
  display:inline-block;
}
.grid{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.grid button{
  width:23%;
  height:60px;
  font-size:14px;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  border:1px solid #ddd;
  padding:6px;
  text-align:center;
  font-size:14px;
}
.total{
  font-size:18px;
  font-weight:bold;
  text-align:center;
}
</style>
</head>

<body>

<div class="header">شاشة مبيعات المندوب</div>

<div class="container">

<!-- العميل -->
<div class="card">
  <input id="customerName" placeholder="اسم العميل (بحث سريع)">
  <div class="grid">
    <button onclick="setType('cash')">نقدي</button>
    <button onclick="setType('credit')">آجل</button>
    <button onclick="showAccount()">كشف حساب</button>
    <button onclick="printInvoice()">طباعة</button>
  </div>
</div>

<!-- الصنف -->
<div class="card">
  <input id="productSearch" placeholder="بحث سريع عن الصنف">
  <input id="qty" type="number" value="1">
  <button onclick="addItem()">إضافة</button>
</div>

<!-- الفاتورة -->
<div class="card">
<table>
<thead>
<tr>
<th>الصنف</th>
<th>ك</th>
<th>سعر</th>
<th>إجمالي</th>
<th>❌</th>
</tr>
</thead>
<tbody id="invoiceBody"></tbody>
</table>
<div class="total">الإجمالي: <span id="total">0</span></div>
<button onclick="saveSale()">حفظ الفاتورة</button>
</div>

</div>

<script>
// ===== حماية المندوب =====
const user = JSON.parse(localStorage.getItem("currentUser"));
if(!user || user.role!=="rep"){
  location.href="rep-login.html";
}

// ===== بيانات =====
let saleType="cash";
let items=[];
const products = JSON.parse(localStorage.getItem("products"))||[];
const customers = JSON.parse(localStorage.getItem("customers"))||[];
const stock = JSON.parse(localStorage.getItem("stock"))||[];

// ===== نوع البيع =====
function setType(t){
  saleType=t;
  alert(t==="cash"?"بيع نقدي":"بيع آجل");
}

// ===== إضافة صنف =====
function addItem(){
  const name=document.getElementById("productSearch").value;
  const qty=+document.getElementById("qty").value;
  const p=products.find(x=>x.name===name);
  if(!p){alert("الصنف غير موجود");return;}
  items.push({
    name:p.name,
    price:p.price,
    qty,
    total:p.price*qty
  });
  render();
}

// ===== عرض =====
function render(){
  const body=document.getElementById("invoiceBody");
  body.innerHTML="";
  let sum=0;
  items.forEach((i,idx)=>{
    sum+=i.total;
    body.innerHTML+=`
      <tr>
        <td>${i.name}</td>
        <td>${i.qty}</td>
        <td>${i.price}</td>
        <td>${i.total}</td>
        <td><button onclick="removeItem(${idx})">❌</button></td>
      </tr>`;
  });
  document.getElementById("total").innerText=sum;
}

function removeItem(i){
  items.splice(i,1);
  render();
}

// ===== حفظ =====
function saveSale(){
  if(items.length===0){alert("الفاتورة فاضية");return;}
  if(saleType==="credit" && !customerName.value){
    alert("اسم العميل مطلوب للبيع الآجل");
    return;
  }

  const sales=JSON.parse(localStorage.getItem("sales"))||[];
  sales.push({
    id:Date.now(),
    repId:user.id,
    customer:customerName.value||"نقدي",
    type:saleType,
    items,
    total:+total.innerText,
    date:new Date().toLocaleString()
  });
  localStorage.setItem("sales",JSON.stringify(sales));

  // تحديث المخزون
  items.forEach(it=>{
    const s=stock.find(x=>x.name===it.name);
    if(s) s.qty-=it.qty;
  });
  localStorage.setItem("stock",JSON.stringify(stock));

  alert("تم الحفظ");
  items=[];
  render();
}

// ===== كشف حساب =====
function showAccount(){
  alert("كشف حساب العميل (قيد التطوير)");
}

// ===== طباعة =====
function printInvoice(){
  window.print();
}
</script>

</body>
</html>
