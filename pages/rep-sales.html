<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>مبيعات المندوب</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  font-family:Arial,Tahoma;
  background:#f3f4f6;
}
.topbar{
  background:#1e3a8a;
  color:#fff;
  padding:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.logout{
  background:#dc2626;
  color:#fff;
  border:none;
  padding:5px 10px;
  border-radius:6px;
  font-size:12px;
}
.container{padding:10px}
.box{
  background:#fff;
  border-radius:10px;
  padding:10px;
  margin-bottom:10px;
}
input,select,button{
  width:100%;
  padding:8px;
  margin-bottom:6px;
  border:1px solid #ccc;
  border-radius:6px;
  font-size:14px;
}
button{
  background:#2563eb;
  color:#fff;
  border:none;
}
.small-btn{
  font-size:12px;
  padding:6px;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  border:1px solid #ddd;
  padding:5px;
  text-align:center;
}
.total{
  font-weight:bold;
  text-align:center;
  font-size:16px;
}
.hidden{display:none}
</style>
</head>

<body>

<div class="topbar">
  <div id="repName"></div>
  <button class="logout" onclick="logout()">خروج</button>
</div>

<div class="container">

<!-- اختيار العميل -->
<div class="box">
  <select id="customer"></select>
  <select id="payType">
    <option value="cash">نقدي</option>
    <option value="credit">آجل</option>
  </select>
  <button class="small-btn" onclick="showStatement()">كشف حساب العميل</button>
</div>

<!-- إضافة صنف -->
<div class="box">
  <input id="itemSearch" placeholder="بحث سريع عن الصنف">
  <input id="qty" type="number" value="1" min="1">
  <button onclick="addItem()">إضافة</button>
</div>

<!-- الفاتورة -->
<div class="box">
  <table>
    <thead>
      <tr>
        <th>الصنف</th>
        <th>ك</th>
        <th>سعر</th>
        <th>إجمالي</th>
      </tr>
    </thead>
    <tbody id="bill"></tbody>
  </table>
  <div class="total">الإجمالي: <span id="total">0</span></div>
</div>

<!-- أزرار -->
<div class="box">
  <button onclick="saveInvoice()">حفظ</button>
  <button onclick="window.print()">طباعة</button>
</div>

<!-- كشف الحساب -->
<div class="box hidden" id="statementBox">
  <h4>كشف حساب العميل</h4>
  <div id="statement"></div>
  <button class="small-btn" onclick="closeStatement()">إغلاق</button>
</div>

</div>

<script>
// ===== حماية =====
const user = JSON.parse(localStorage.getItem("currentUser"));
if(!user || user.role!=="rep"){
  location.href="../index.html";
}
repName.innerText = "المندوب: " + user.name;

// ===== تحميل الداتا =====
let items = JSON.parse(localStorage.getItem("items")||"[]");
let customers = JSON.parse(localStorage.getItem("customers")||"[]");
let stock = JSON.parse(localStorage.getItem("stock")||"[]");
let reports = JSON.parse(localStorage.getItem("reports")||"[]");
let treasury = JSON.parse(localStorage.getItem("treasury")||"0");

// ===== العملاء =====
customer.innerHTML = customers.map(c=>
  `<option value="${c.name}">${c.name}</option>`
).join("");

// ===== الفاتورة =====
let bill=[], total=0;

function addItem(){
  let name=itemSearch.value;
  let q=+qty.value;
  let item=items.find(i=>i.name===name);
  if(!item) return alert("الصنف غير موجود");

  let s=stock.find(x=>x.name===name);
  if(!s || s.qty<q) return alert("رصيد غير كافي");

  let rowTotal=item.price*q;
  bill.push({name,qty:q,price:item.price,rowTotal});
  total+=rowTotal;
  render();
}

function render(){
  billEl="";
  bill.forEach(r=>{
    billEl+=`<tr>
      <td>${r.name}</td>
      <td>${r.qty}</td>
      <td>${r.price}</td>
      <td>${r.rowTotal}</td>
    </tr>`;
  });
  bill.innerHTML=billEl;
  document.getElementById("total").innerText=total;
}

// ===== حفظ الفاتورة =====
function saveInvoice(){
  if(!bill.length) return alert("الفاتورة فاضية");

  let invoice={
    rep:user.name,
    customer:customer.value,
    payType:payType.value,
    total,
    date:new Date().toLocaleString()
  };

  reports.push(invoice);
  localStorage.setItem("reports",JSON.stringify(reports));

  if(payType.value==="cash"){
    treasury+=total;
    localStorage.setItem("treasury",treasury);
  }

  bill.forEach(r=>{
    let s=stock.find(x=>x.name===r.name);
    s.qty-=r.qty;
  });
  localStorage.setItem("stock",JSON.stringify(stock));

  alert("تم الحفظ");
  location.reload();
}

// ===== كشف حساب =====
function showStatement(){
  let cust=customer.value;
  let list=reports.filter(r=>r.customer===cust);
  statement.innerHTML=list.map(r=>
    `<div>${r.date} - ${r.total}</div>`
  ).join("");
  statementBox.classList.remove("hidden");
}
function closeStatement(){
  statementBox.classList.add("hidden");
}

// ===== خروج =====
function logout(){
  localStorage.removeItem("currentUser");
  location.href="../index.html";
}
</script>

</body>
</html>
