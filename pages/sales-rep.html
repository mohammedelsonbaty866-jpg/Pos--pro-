<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</title>

<link rel="stylesheet" href="../css/menu.css">

<style>
body{background:#f2f4f8}
.page{padding:10px}

/* Ø£Ø²Ø±Ø§Ø± Ù…Ø±Ø¨Ø¹Ø© */
.btn-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
  margin-bottom:10px
}
.btn{
  background:#2f6df6;
  color:#fff;
  border:0;
  border-radius:10px;
  padding:12px 6px;
  font-size:13px;
  text-align:center
}
.btn.green{background:#28a745}
.btn.gray{background:#6c757d}
.btn.red{background:#dc3545}

.card{
  background:#fff;
  border-radius:12px;
  padding:10px;
  margin-bottom:10px
}

input,select{
  width:100%;
  padding:10px;
  margin:4px 0;
  font-size:15px
}

/* Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ */
.list{
  background:#fff;
  border-radius:8px;
  box-shadow:0 3px 8px rgba(0,0,0,.15);
  max-height:160px;
  overflow:auto;
  position:absolute;
  width:100%;
  z-index:9
}
.list div{
  padding:8px;
  cursor:pointer
}
.list div:hover{background:#eee}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px
}
th,td{
  border-bottom:1px solid #ddd;
  padding:6px;
  text-align:center
}
</style>
</head>

<body>

<!-- ===== Ø§Ù„Ù…Ù†ÙŠÙˆ ===== -->
<div class="sidebar" id="sidebar">
  <div class="menu-item active">ğŸ§¾ Ù…Ø¨ÙŠØ¹Ø§ØªÙŠ</div>
  <div class="menu-item" onclick="go('settings.html')">âš™ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
</div>

<div class="main-content">
<div class="page">

<!-- Ø£Ø²Ø±Ø§Ø± Ø³Ø±ÙŠØ¹Ø© -->
<div class="btn-grid">
  <div class="btn" onclick="saveSale()">ğŸ’¾ Ø­ÙØ¸</div>
  <div class="btn green" onclick="printInvoice()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø©</div>
  <div class="btn gray" onclick="customerStatement()">ğŸ“‘ ÙƒØ´Ù Ø¹Ù…ÙŠÙ„</div>
  <div class="btn red" onclick="clearInvoice()">ğŸ—‘ Ù…Ø³Ø­</div>
</div>

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
<div class="card">
  <input id="customerSearch" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„" oninput="searchCustomers(this.value)">
  <div id="customerList" class="list"></div>

  <div class="btn gray" onclick="addNewCustomer()">â• Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</div>

  <select id="saleType">
    <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
    <option value="credit">Ø¢Ø¬Ù„</option>
  </select>
</div>

<!-- Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù -->
<div class="card">
  <input id="itemSearch" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ Ø¹Ù† Ø§Ù„ØµÙ†Ù" oninput="searchItems(this.value)">
  <div id="itemList" class="list"></div>

  <input id="qty" type="number" value="1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
  <input id="price" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">
  <input id="discount" type="number" placeholder="Ø®ØµÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">

  <div class="btn" onclick="addItem()">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</div>
</div>

<!-- Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
<div class="card">
  <table>
    <thead>
      <tr>
        <th>Ø§Ù„ØµÙ†Ù</th>
        <th>Ùƒ</th>
        <th>Ø³</th>
        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
      </tr>
    </thead>
    <tbody id="invoiceBody"></tbody>
  </table>
  <h3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total">0</span></h3>
</div>

</div>
</div>

<script>
/* ===== ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===== */
const items = JSON.parse(localStorage.getItem("items")) || [];
let customers = JSON.parse(localStorage.getItem("customers")) || [];
const rep = JSON.parse(localStorage.getItem("currentRep"));

let invoice = [];
let total = 0;
let selectedCustomer = "Ù†Ù‚Ø¯ÙŠ";

/* ===== Ø¨Ø­Ø« Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ===== */
function searchCustomers(txt){
  customerList.innerHTML="";
  if(!txt) return;
  customers.filter(c=>c.name.includes(txt)).forEach(c=>{
    const d=document.createElement("div");
    d.innerText=c.name;
    d.onclick=()=>{
      selectedCustomer=c.name;
      customerSearch.value=c.name;
      customerList.innerHTML="";
    };
    customerList.appendChild(d);
  });
}

/* ===== Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ ===== */
function addNewCustomer(){
  const name = prompt("Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:");
  if(!name) return;
  customers.push({id:Date.now(),name});
  localStorage.setItem("customers",JSON.stringify(customers));
  selectedCustomer=name;
  customerSearch.value=name;
}

/* ===== Ø¨Ø­Ø« Ø§Ù„Ø£ØµÙ†Ø§Ù ===== */
function searchItems(txt){
  itemList.innerHTML="";
  if(!txt) return;
  items.filter(i=>i.name.includes(txt)).forEach(i=>{
    const d=document.createElement("div");
    d.innerText=i.name;
    d.onclick=()=>{
      itemSearch.value=i.name;
      price.value=i.price;
      itemList.innerHTML="";
    };
    itemList.appendChild(d);
  });
}

/* ===== Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù ===== */
function addItem(){
  if(!itemSearch.value)return;

  invoice.push({
    name:itemSearch.value,
    qty:+qty.value,
    price:+price.value,
    discount:+discount.value||0
  });
  render();
}

/* ===== Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ===== */
function render(){
  invoiceBody.innerHTML="";
  total=0;
  invoice.forEach(i=>{
    const rowTotal=(i.qty*i.price)-i.discount;
    total+=rowTotal;
    invoiceBody.innerHTML+=`
      <tr>
        <td>${i.name}</td>
        <td>${i.qty}</td>
        <td>${i.price}</td>
        <td>${rowTotal}</td>
      </tr>
    `;
  });
  document.getElementById("total").innerText=total;
}

/* ===== Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ¹ ===== */
function saveSale(){
  if(invoice.length===0) return alert("ÙØ§ØªÙˆØ±Ø© ÙØ§Ø¶ÙŠØ©");
  if(saleType.value==="credit" && selectedCustomer==="Ù†Ù‚Ø¯ÙŠ")
    return alert("Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø¢Ø¬Ù„ ÙŠØªØ·Ù„Ø¨ Ø¹Ù…ÙŠÙ„");

  const sales=JSON.parse(localStorage.getItem("sales"))||[];
  sales.push({
    id:Date.now(),
    rep:rep?.username,
    customer:selectedCustomer,
    type:saleType.value,
    items:invoice,
    total,
    date:new Date().toLocaleString()
  });
  localStorage.setItem("sales",JSON.stringify(sales));

  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");
  clearInvoice();
}

/* ===== Ù…Ø³Ø­ ===== */
function clearInvoice(){
  invoice=[];
  render();
}

/* ===== ÙƒØ´Ù Ø­Ø³Ø§Ø¨ ===== */
function customerStatement(){
  if(!selectedCustomer) return;
  localStorage.setItem("statementCustomer",selectedCustomer);
  location.href="customer-statement.html";
}

/* ===== Ø·Ø¨Ø§Ø¹Ø© ===== */
function printInvoice(){
  window.print();
}
</script>

</body>
</html>
